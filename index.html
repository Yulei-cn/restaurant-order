<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CUBE - Commande</title>
  <style>
    body { font-family: Arial; max-width: 900px; margin: auto; padding: 20px; }
    h1 { text-align: center; }
    h2 { margin-top: 30px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    .lang-switch { text-align: center; margin-bottom: 20px; }
    .lang-switch button {
      font-size: 20px; padding: 8px 16px; margin: 0 5px;
      background-color: #aed581; border: none; border-radius: 6px; cursor: pointer;
    }
    table {3
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    table th, table td {
      border: 1px solid #ccc; padding: 8px; text-align: center;
    }
    table th { background-color: #f1f8e9; }
    .item-controls button {
      padding: 2px 8px; font-size: 16px; margin: 0 5px;
    }
    .total-price {
      text-align: right; font-size: 1.4em; margin-top: 20px; font-weight: bold;
    }
    label { display: block; margin-top: 15px; }
    input[type="text"], input[type="tel"] {
      width: 100%; padding: 8px; margin-top: 5px;
    }
    #submitBtn {
      margin-top: 20px; font-size: 18px; padding: 10px 20px;
      background: #81c784; border: none; border-radius: 6px; cursor: pointer;
    }
  </style>
</head>
<body>

<div class="lang-switch">
  <button onclick="setLang('fr')">üá´üá∑ Fran√ßais</button>
  <button onclick="setLang('zh')">üá®üá≥ ‰∏≠Êñá</button>
</div>

<h1 id="title">ü•° CUBE - Commande</h1>
<div id="infoBox">üìç 7 Rue Blanche, 75009 Paris ‚Äî ‚è∞ 11:30‚Äì20:30</div>

<form id="orderForm">
  <div id="menuTables"></div>

  <div class="total-price">üí∞ Total : <span id="total">0.00</span> ‚Ç¨</div>

  <h2 data-fr="Informations de retrait (optionnel)" data-zh="Â§áÊ≥®‰ø°ÊÅØÔºàÂèØÈÄâÔºâ">Informations de retrait (optionnel)</h2>

  <label data-fr="Nom du client (obligatoire)" data-zh="ÂßìÂêçÔºàÂøÖÂ°´Ôºâ">Nom du client (obligatoire)
  <input type="text" name="customer_name" id="customer_name" required />
  </label>

  <label data-fr="Adresse (optionnel)" data-zh="Âú∞ÂùÄÔºàÂèØÈÄâÔºâ">Adresse (optionnel)
    <input type="text" name="address" id="address" />
  </label>
  
  <label data-fr="T√©l√©phone (optionnel)" data-zh="ÁîµËØùÔºàÂèØÈÄâÔºâ">T√©l√©phone (optionnel)
    <input type="tel" name="phone" id="phone" />
  </label>
  
  <label data-fr="Remarques (optionnel)" data-zh="Â§áÊ≥®ÔºàÂèØÈÄâÔºâ">Remarques (optionnel)
    <input type="text" name="notes" id="notes" />
  </label>


  <button type="submit" id="submitBtn">‚úÖ Commander</button>
</form>
<dialog id="formuleDialog">
  <form method="dialog" id="formuleSelectForm" style="max-width:600px;margin:auto;">
    <h2 id="formuleTitle">Formule</h2>

    <label>ü•ó Entr√©e :</label>
    <select id="formuleEntree" required></select>

    <label>üçõ Plats chauds :</label>
    <select id="formulePlat1" required></select>
    <select id="formulePlat2" required></select>
    <select id="formulePlat3" class="extra-plat" style="display:none;"></select>

    <label>üçö Riz ou Nouilles :</label>
    <select id="formuleBase">
      <option value="Riz nature / Á±≥È•≠">Riz nature / Á±≥È•≠</option>
      <option value="Riz saut√© / ÁÇíÈ•≠">Riz saut√© / ÁÇíÈ•≠ (+1‚Ç¨)</option>
      <option value="Nouilles saut√©es / ÁÇíÈù¢">Nouilles saut√©es / ÁÇíÈù¢ (+1‚Ç¨)</option>
    </select>

    <label>ü•§ Ajouter boisson ?</label>
    <select id="formuleBoisson">
      <option value="">Non</option>
      <option value="Coca-Cola / ÂèØ‰πê">Coca-Cola / ÂèØ‰πê (+1‚Ç¨)</option>
      <option value="Sprite / Èõ™Á¢ß">Sprite / Èõ™Á¢ß (+1‚Ç¨)</option>
      <option value="Fanta / Ëä¨Ëææ">Fanta / Ëä¨Ëææ (+1‚Ç¨)</option>
      <option value="Th√© √† la p√™che / Ê°ÉËå∂">Th√© √† la p√™che / Ê°ÉËå∂ (+1‚Ç¨)</option>
      <option value="Jus d‚Äôorange / Ê©ôÊ±Å">Jus d‚Äôorange / Ê©ôÊ±Å (+1‚Ç¨)</option>
      <option value="Eau min√©rale / ÁüøÊ≥âÊ∞¥">Eau min√©rale / ÁüøÊ≥âÊ∞¥ (+1‚Ç¨)</option>
    </select>

    <div style="margin-top: 15px; text-align: center;">
      <button type="submit">‚úÖ Ajouter au panier</button>
      <button type="button" onclick="document.getElementById('formuleDialog').close()">‚ùå Annuler</button>
    </div>
  </form>
</dialog>

<p id="result"></p>

<script>
let cart = {};
const categories = [
  {
    title: "ü•ó Entr√©es / ÂâçËèú",
    items: [
      ["Concombre marin√© / ÊãçÈªÑÁìú", 5.80],
      ["Radis aigre-doux / ÈÖ∏ÁîúËêùÂçú", 5.80],
      ["Pommes de terre r√¢p√©es / ÂáâÊãåÂúüË±Ü‰∏ù", 5.80],
      ["Algues marin√©es / Êµ∑Â∏¶‰∏ù", 5.80],
    ]
  },
  {
    title: "üçõ Plats chauds / ÁÉ≠Ëèú",
    items: [
      ["B≈ìuf mijot√© / ÁÉßÁâõËÇâ", 8.80],
      ["Porc brais√© / Á∫¢ÁÉßËÇâ", 8.80],
      ["Poulet aigre-doux / Á≥ñÈÜãÈ∏°", 8.80],
      ["Porc saut√© croustillant / Ê∫úËÇâÊÆµ", 8.80],
      ["Poulet frit / ÁÇ∏È∏°Âùó", 8.80],
      ["Porc frit croustillant / Â∞èÈÖ•ËÇâ", 8.80],
      ["Poulet Kung Pao / ÂÆ´‰øùÈ∏°‰∏Å", 8.80],
      ["Aubergines brais√©es / ÁÉßËåÑÂ≠ê", 6.80],
      ["Haricots verts saut√©s / Âπ≤ÁÖ∏Ë±ÜËßí", 6.80],
      ["≈íufs aux tomates / Áï™ËåÑÁÇíÈ∏°Ëõã", 6.80],
    ]
  },
  {
    title: "üçö Accompagnements / ‰∏ªÈ£ü",
    items: [
      ["Riz nature / Á±≥È•≠", 2.50],
      ["Riz saut√© / ÁÇíÈ•≠", 5.80],
      ["Nouilles saut√©es / ÁÇíÈù¢", 6.80],
    ]
  },
  {
    title: "ü•Ø Snacks / Â∞èÂêÉ",
    items: [
      ["Roujiamo porc / Áå™ËÇâËÇâÂ§πÈ¶ç", 5.80],
      ["Roujiamo b≈ìuf / ÁâõËÇâËÇâÂ§πÈ¶ç", 6.80],
    ]
  },
  {
    title: "ü•§ Boissons / È•ÆÂìÅ",
    items: [
      ["Coca-Cola / ÂèØ‰πê", 2.00],
      ["Sprite / Èõ™Á¢ß", 2.00],
      ["Fanta / Ëä¨Ëææ", 2.00],
      ["Th√© √† la p√™che / Ê°ÉËå∂", 2.00],
      ["Jus d‚Äôorange / Ê©ôÊ±Å", 2.00],
      ["Eau min√©rale / ÁüøÊ≥âÊ∞¥", 2.00],
    ]
  }
];

function renderTables() {
  const container = document.getElementById("menuTables");
  categories.forEach(cat => {
    const section = document.createElement("section");
    section.innerHTML = `<h2>${cat.title}</h2><table>
      <tr><th>Nom</th><th>Prix</th><th>Quantit√©</th></tr>
      ${cat.items.map(([label, price]) => {
        const key = `${label} - ${price.toFixed(2)}‚Ç¨`;
        return `<tr>
          <td>${label}</td>
          <td>${price.toFixed(2)} ‚Ç¨</td>
          <td class="item-controls">
            <button type="button" onclick="changeQty('${key}', -1)">‚ûñ</button>
            <span id="qty-${key}">0</span>
            <button type="button" onclick="changeQty('${key}', 1)">‚ûï</button>
          </td>
        </tr>`;
      }).join("")}
    </table>`;
    container.appendChild(section);
  });
}

function changeQty(name, delta) {
  cart[name] = Math.max(0, (cart[name] || 0) + delta);
  document.getElementById(`qty-${name}`).textContent = cart[name];
  updateTotal();
}

function updateTotal() {
  let total = 0;
  for (const [name, qty] of Object.entries(cart)) {
    const price = parseFloat(name.match(/- ([\d.]+)‚Ç¨/)[1]);
    total += price * qty;
  }
  document.getElementById("total").textContent = total.toFixed(2);
}

function setLang(lang) {
  document.documentElement.lang = lang;
  document.getElementById("title").textContent = lang === "zh" ? "ü•° CUBEÁõíÈ•≠ÁÇπÈ§ê" : "ü•° CUBE - Commande";
  document.getElementById("submitBtn").textContent = lang === "zh" ? "‚úÖ Êèê‰∫§ËÆ¢Âçï" : "‚úÖ Commander";
  document.getElementById("infoBox").textContent = lang === "zh"
    ? "üìç Â∑¥Èªé9Âå∫ Rue Blanche 7Âè∑ ‚Äî ‚è∞ Ëê•‰∏öÊó∂Èó¥ 11:30‚Äì20:30"
    : "üìç 7 Rue Blanche, 75009 Paris ‚Äî ‚è∞ 11:30‚Äì20:30";
  document.querySelectorAll("[data-fr]").forEach(el => {
    el.textContent = lang === "zh" ? el.dataset.zh : el.dataset.fr;
  });
}

document.getElementById("orderForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const items = [];
  for (const [name, qty] of Object.entries(cart)) {
    if (qty > 0) {
      const price = parseFloat(name.match(/- ([\d.]+)‚Ç¨/)[1]);
      items.push({ name, qty, price });
    }
  }
  if (items.length === 0) {
    document.getElementById("result").textContent = "‚ö†Ô∏è Veuillez choisir un produit.";
    return;
  }
  
  const customer_name = document.getElementById("customer_name").value;
  const address = document.getElementById("address").value;
  const phone = document.getElementById("phone").value;
  const notes = document.getElementById("notes").value;

  const res = await fetch("https://fdbcypvxuikhmxvyyvmb.supabase.co/rest/v1/orders", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      apikey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkYmN5cHZ4dWlraG14dnl5dm1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUyNjY5MzUsImV4cCI6MjA2MDg0MjkzNX0.Ju8wyqBS1irCWgtpBT_RanrqVErQt-gQkWdzb69XMr4",
      Authorization: "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkYmN5cHZ4dWlraG14dnl5dm1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUyNjY5MzUsImV4cCI6MjA2MDg0MjkzNX0.Ju8wyqBS1irCWgtpBT_RanrqVErQt-gQkWdzb69XMr4",
      Prefer: "return=minimal"
    },
  body: JSON.stringify({
    user_id: null,
    customer_name,
    status: "Êñ∞ËÆ¢Âçï",
    items,
    address,
    phone,
    notes
  })
  });

  if (res.ok) {
    cart = {};
    document.getElementById("orderForm").reset();
    for (const key in cart) document.getElementById(`qty-${key}`).textContent = "0";
    updateTotal();
    document.getElementById("result").textContent = "‚úÖ Commande envoy√©e / ËÆ¢ÂçïÂ∑≤Êèê‰∫§";
  } else {
    document.getElementById("result").textContent = "‚ùå Erreur / Êèê‰∫§Â§±Ë¥•";
  }
});

renderTables();

function openFormule(type) {
  const entrees = categories.find(c => c.title.includes("Entr√©es")).items;
  const plats = categories.find(c => c.title.includes("Plats chauds")).items;

  // Â°´ÂÖÖ entr√©e ‰∏ãÊãâ
  const entreeSelect = document.getElementById("formuleEntree");
  entreeSelect.innerHTML = entrees.map(([n]) => `<option>${n}</option>`).join("");

  // Â°´ÂÖÖ plats ‰∏ãÊãâ
  const plat1 = document.getElementById("formulePlat1");
  const plat2 = document.getElementById("formulePlat2");
  const plat3 = document.getElementById("formulePlat3");
  [plat1, plat2, plat3].forEach(sel => {
    sel.innerHTML = plats.map(([n]) => `<option>${n}</option>`).join("");
  });

  // ÊéßÂà∂Á¨¨3‰∏™ËèúÊòØÂê¶ÂèØËßÅ
  if (type === "Formule 2") {
    plat3.style.display = "block";
  } else {
    plat3.style.display = "none";
  }

  document.getElementById("formuleTitle").textContent = type;
  document.getElementById("formuleDialog").showModal();
}

document.getElementById("formuleSelectForm").addEventListener("submit", () => {
  const type = document.getElementById("formuleTitle").textContent;
  let price = type === "Formule 1" ? 11.80 : 13.80;

  const entree = document.getElementById("formuleEntree").value;
  const plat1 = document.getElementById("formulePlat1").value;
  const plat2 = document.getElementById("formulePlat2").value;
  const plat3 = document.getElementById("formulePlat3").value;
  const base = document.getElementById("formuleBase").value;
  const boisson = document.getElementById("formuleBoisson").value;

  if (base.includes("saut√©") || base.includes("Nouilles")) price += 1;
  if (boisson) price += 1;

  let desc = `${type}: ${entree}, ${plat1}, ${plat2}`;
  if (type === "Formule 2") desc += `, ${plat3}`;
  desc += ` + ${base}`;
  if (boisson) desc += ` + ${boisson}`;

  const key = `${desc} - ${price.toFixed(2)}‚Ç¨`;
  cart[key] = (cart[key] || 0) + 1;

  updateTotal();
  document.getElementById(`formuleDialog`).close();
});

</script>

<!-- Âú∞Âõæ -->
<footer style="margin-top: 40px;">
  <h2 style="text-align:center;">üìç Nous trouver</h2>
  <iframe
    src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d8826.566768564202!2d2.327968040327757!3d48.87434070843596!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x47e66f9eb79f4ec3%3A0x8afbe2aac1fe8dd8!2sCUBE!5e0!3m2!1szh-CN!2sfr!4v1749454247270!5m2!1szh-CN!2sfr" width="600" height="450" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"
    width="100%" height="300" style="border:0; border-radius: 8px;" allowfullscreen="" loading="lazy">
  </iframe>
</footer>

</body>
</html>
